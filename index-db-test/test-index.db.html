<!DOCTYPE HTML>
<html>
	<title>IndexedDB Test</title>
	<script>
		
		
		var idx_database = {}
		
		var test_data = [
			{id: 1, name: "John Archer", age: 35, location: "Broken Bow"},
			{id: 2, name: "Hoshi", age: 32, location: "Tokyo"}
		];
		
		function log(msg) {
			document.write(msg +"<br>");
		}
		
		function error(msg) {
			document.write("<font color=red>" +msg +"</font><br>");
		}
		
		function init() {
			window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB;
			window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange;
			window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction;
			if(window.indexedDB) {
				log("IndexDB Implementation detected");
			} else {
				error("IndexDB Implementation not detected");
				return;
			}
			startup();
		}
		
		function startup() {
			var request = window.indexedDB.open("SimpleTestDatabase", "This is a simple database to test IndexedDB");
			request.onsuccess = function(event) {
			  idx_database = request.result;
			  log("Database Opened");
			  idx_database.onversionchange = function() {
			    log("Version change request, so closing the database");
			    idx_database.db.close();
			    delete idx_database.db;
			  }
			  createObjectStore();
			 loadObjects();
			};
			request.onerror = function(e) {
			  error(e);
			};
		}
		
		//Created a object store in the database (Eq to creating a table)
		function createObjectStore() {
			var ver = "1.0";
			if(ver != idx_database.version) {
				var set_version_request = idx_database.setVersion(ver);
				set_version_request.onerror = function(e) {
					error(e);
				};
				set_version_request.onsuccess = function(e) {
					idx_database.createObjectStore("enterprise_nx01", { keyPath: "id", autoincrement: true } );
					log("Object Store enterprise_nx01 created");
				}
			} else {
				cleanup();
			}
 		}
		
		
		//Cleanup database before load
		function cleanup() {
			var trans = idx_database.transaction(["enterprise_nx01"], IDBTransaction.READ_WRITE, 0);
			//Get the object store
			var obj_store = trans.objectStore("enterprise_nx01");
			var request = obj_store.delete(1);
			request.onsuccess = onCleanUpSuccess;
			request.onerror = onCleanUpError;
			var request1 = obj_store.delete(2);
			request1.onsuccess = onCleanUpSuccess;
			request1.onerror = onCleanUpError;
		}
		
		function onCleanUpSuccess() {
			//Do nothing for now
		}
		
		function onCleanUpError(e) {
			error(e);
		}
		
		//Load some test objects into the database
		function loadObjects() {
			var trans = idx_database.transaction(["enterprise_nx01"], IDBTransaction.READ_WRITE, 0);
			//Get the object store
			var obj_store = trans.objectStore("enterprise_nx01");
			//Iterate through test data and store the objects in the store
			for(var i=0; i< test_data.length; i++) {
				var data = test_data[i];
				var request = obj_store.add(data);
				request.onsuccess = function(event) {
					log("Record save for enterprise_nx01 - Name: " +data.name +" Age: " +data.age +" Location: " +data.location);
				};
				request.onerror = function(e) {
					error(e);
				};
			}
		}
	</script>
	<body onload="init()">
		<p>IndexDB Test</p>
	</body>
</html>